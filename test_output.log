============================= test session starts ==============================
platform darwin -- Python 3.9.6, pytest-7.3.1, pluggy-1.0.0 -- /Library/Developer/CommandLineTools/usr/bin/python3
cachedir: .pytest_cache
metadata: {'Python': '3.9.6', 'Platform': 'macOS-15.6.1-arm64-arm-64bit', 'Packages': {'pytest': '7.3.1', 'pluggy': '1.0.0'}, 'Plugins': {'asyncio': '0.21.0', 'anyio': '4.9.0', 'integration': '0.2.3', 'html': '4.1.1', 'xdist': '3.8.0', 'timeout': '2.4.0', 'metadata': '3.1.1', 'mock': '3.10.0', 'Faker': '30.8.2', 'cov': '4.0.0', 'benchmark': '4.0.0'}}
benchmark: 4.0.0 (defaults: timer=time.perf_counter disable_gc=False min_rounds=5 min_time=0.000005 max_time=1.0 calibration_precision=10 warmup=False warmup_iterations=100000)
rootdir: /Users/dylantullberg/Developer/riptide-test-sites
configfile: pytest.ini
plugins: asyncio-0.21.0, anyio-4.9.0, integration-0.2.3, html-4.1.1, xdist-3.8.0, timeout-2.4.0, metadata-3.1.1, mock-3.10.0, Faker-30.8.2, cov-4.0.0, benchmark-4.0.0
asyncio: mode=strict
collecting ... collected 163 items

tests/test_anti_bot.py::TestAntiBotLite::test_site_is_healthy FAILED     [  0%]
tests/test_anti_bot.py::TestAntiBotLite::test_normal_user_agent_allowed FAILED [  1%]
tests/test_anti_bot.py::TestAntiBotLite::test_bot_user_agent_blocked FAILED [  1%]
tests/test_anti_bot.py::TestAntiBotLite::test_rate_limiting_enforced FAILED [  2%]
tests/test_anti_bot.py::TestAntiBotLite::test_honeypot_field_detection PASSED [  3%]
tests/test_anti_bot.py::TestAntiBotLite::test_javascript_challenge_present PASSED [  3%]
tests/test_anti_bot.py::TestAntiBotLite::test_cookie_validation FAILED   [  4%]
======================================================================
‚úÖ Test session completed
======================================================================



=================================== FAILURES ===================================
_____________________ TestAntiBotLite.test_site_is_healthy _____________________
tests/test_anti_bot.py:33: in test_site_is_healthy
    assert health_check(SITE_PORT), "anti-bot-lite.site is not healthy"
E   AssertionError: anti-bot-lite.site is not healthy
E   assert False
E    +  where False = <function health_check.<locals>.check at 0x106a32820>(5011)
        health_check = <function health_check.<locals>.check at 0x106a32820>
        self       = <test_anti_bot.TestAntiBotLite object at 0x1067eec40>
---------------------------- Captured stdout setup -----------------------------

======================================================================
üß™ RipTide Test Sites - Testing Environment
======================================================================
Base URL: http://localhost
Fixture Seed: 42
Test Timeout: 30s
Ground Truth Dir: /Users/dylantullberg/Developer/riptide-test-sites/ground-truth
======================================================================

----------------------------- Captured stdout call -----------------------------
‚ùå Site on port 5011 returned 400
________________ TestAntiBotLite.test_normal_user_agent_allowed ________________
tests/test_anti_bot.py:51: in test_normal_user_agent_allowed
    assert response.status_code == 200, \
E   AssertionError: Normal browser user-agent should be allowed
E   assert 400 == 200
E    +  where 400 = <Response [400]>.status_code
        headers    = {'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36'}
        http_client = <requests.sessions.Session object at 0x106a305b0>
        response   = <Response [400]>
        self       = <test_anti_bot.TestAntiBotLite object at 0x106916bb0>
        site_url   = <function site_url.<locals>.generate at 0x106b10550>
        url        = 'http://localhost:5011/'
_________________ TestAntiBotLite.test_bot_user_agent_blocked __________________
tests/test_anti_bot.py:89: in test_bot_user_agent_blocked
    assert blocked_count >= 2, \
E   AssertionError: At least 2 bot user-agents should be blocked, got 0
E   assert 0 >= 2
        blocked_count = 0
        bot_user_agents = ['python-requests', 'curl/7.0', 'wget/1.0', 'bot', 'crawler', 'spider']
        response   = <Response [400]>
        self       = <test_anti_bot.TestAntiBotLite object at 0x1069165e0>
        session    = <requests.sessions.Session object at 0x106aa54c0>
        site_url   = <function site_url.<locals>.generate at 0x106b105e0>
        ua         = 'spider'
        url        = 'http://localhost:5011/'
_________________ TestAntiBotLite.test_rate_limiting_enforced __________________
tests/test_anti_bot.py:119: in test_rate_limiting_enforced
    assert rate_limited, "Rate limiting should be enforced after rapid requests"
E   AssertionError: Rate limiting should be enforced after rapid requests
E   assert False
        http_client = <requests.sessions.Session object at 0x106a305b0>
        i          = 19
        last_response = <Response [400]>
        rate_limited = False
        response   = <Response [400]>
        responses  = [400, 400, 400, 400, 400, 400, ...]
        self       = <test_anti_bot.TestAntiBotLite object at 0x106916a00>
        site_url   = <function site_url.<locals>.generate at 0x106b10b80>
        url        = 'http://localhost:5011/api/data'
____________________ TestAntiBotLite.test_cookie_validation ____________________
tests/test_anti_bot.py:215: in test_cookie_validation
    assert len(cookies_after_first) > 0 or response1.status_code == 200, \
E   AssertionError: Site should set cookies for tracking
E   assert (0 > 0 or 400 == 200)
E    +  where 0 = len(<RequestsCookieJar[]>)
E    +  and   400 = <Response [400]>.status_code
        cookies_after_first = <RequestsCookieJar[]>
        response1  = <Response [400]>
        response2  = <Response [400]>
        self       = <test_anti_bot.TestAntiBotLite object at 0x106886370>
        session    = <requests.sessions.Session object at 0x106b2df40>
        site_url   = <function site_url.<locals>.generate at 0x106b109d0>
        url        = 'http://localhost:5011/'
=========================== short test summary info ============================
FAILED tests/test_anti_bot.py::TestAntiBotLite::test_site_is_healthy - Assert...
FAILED tests/test_anti_bot.py::TestAntiBotLite::test_normal_user_agent_allowed
FAILED tests/test_anti_bot.py::TestAntiBotLite::test_bot_user_agent_blocked
FAILED tests/test_anti_bot.py::TestAntiBotLite::test_rate_limiting_enforced
FAILED tests/test_anti_bot.py::TestAntiBotLite::test_cookie_validation - Asse...
!!!!!!!!!!!!!!!!!!!!!!!!!! stopping after 5 failures !!!!!!!!!!!!!!!!!!!!!!!!!!!
========================= 5 failed, 2 passed in 2.39s ==========================
